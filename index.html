<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESGoepardy â€” 2024 ESG Edition (Static)</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Source+Sans+3:wght@400;600&display=swap');
    :root{
      --bg:#010720;
      --bg-accent:#0b1e66;
      --stage-fade:#020d3d;
      --text:#f2f5ff;
      --muted:#9daae0;
      --indigo50:rgba(13,32,105,.8);
      --indigo100:rgba(28,54,145,.85);
      --blue700:#0b1a63;
      --blue800:#041048;
      --amber200:#f9c642;
      --amber300:#d89a1e;
      --emerald100:#3fa1ff;
      --emerald200:#5ab7ff;
      --gray200:rgba(255,255,255,.16);
      --gray300:rgba(255,255,255,.25);
      --fuchsia700:#b53cce;
      --overlay:rgba(2,6,25,.82);
      --heading-font:'Cinzel','Times New Roman',serif;
      --body-font:'Source Sans 3',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
      --tile-width:6.75rem;
      --tile-height:6.25rem;
      --cat-height:4.5rem;
      --tile-border:4px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(circle at 15% 15%,rgba(73,103,189,.45) 0,transparent 42%),
        radial-gradient(circle at 85% 20%,rgba(76,108,214,.35) 0,transparent 48%),
        linear-gradient(160deg,var(--bg) 0%,var(--bg-accent) 55%,var(--stage-fade) 100%);
      color:var(--text);
      font-family:var(--body-font);
      min-height:100vh;
      background-attachment:fixed;
    }
    .container{max-width:72rem;margin:0 auto;padding:1.5rem}
    h1{font-size:1.875rem;line-height:2.25rem;margin:0 0 .25rem;font-weight:700;font-family:var(--heading-font);letter-spacing:.08em;text-transform:uppercase;color:var(--amber200);text-shadow:0 6px 18px rgba(0,0,0,.6)}
    p{margin:.25rem 0}
    .muted{color:var(--muted)}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:0;border-radius:12px;padding:.5rem 1rem;cursor:pointer;font-weight:600}
    .btn-primary{background:#111827;color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.15)}
    .btn-primary:hover{box-shadow:0 6px 12px rgba(0,0,0,.18)}
    .btn-alt{background:var(--gray200)}
    .board-wrapper{
      position:relative;
      margin:0 auto 1.5rem;
      padding:1.25rem 2rem 2rem;
      max-width:calc(4 * var(--tile-width) + 7rem);
      background:linear-gradient(160deg,rgba(4,16,64,.92) 0%,rgba(3,9,46,.95) 65%,rgba(2,6,30,.98) 100%);
      border-radius:26px;
      border:1px solid rgba(249,198,66,.35);
      box-shadow:0 22px 40px rgba(0,0,0,.65),0 0 0 8px rgba(9,21,77,.65);
      display:flex;
      justify-content:center;
      overflow-x:auto;
    }
    .grid{display:flex;gap:.65rem;min-width:calc(4 * var(--tile-width) + 1.95rem);padding:.5rem 0}
    .col{display:grid;grid-template-rows:var(--cat-height) repeat(4,var(--tile-height));gap:.5rem;flex:0 0 var(--tile-width)}
    .cat{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:.35rem .45rem;
      text-align:center;
      border-radius:18px;
      border:var(--tile-border) solid rgba(10,26,102,.9);
      background:linear-gradient(150deg,rgba(9,25,99,.95) 0%,rgba(6,18,75,.98) 100%);
      font-weight:700;
      font-family:var(--heading-font);
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--amber200);
      font-size:1rem;
      line-height:1.2;
      text-shadow:0 4px 12px rgba(0,0,0,.85);
    }
    .tile{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      border-radius:18px;
      border:var(--tile-border) solid rgba(12,32,122,.9);
      background:linear-gradient(180deg,rgba(4,16,70,.98) 0%,rgba(3,12,52,.98) 100%);
      box-shadow:inset 0 0 18px rgba(0,0,0,.55),0 12px 18px rgba(0,0,0,.5);
      transition:transform .25s ease,box-shadow .25s ease,filter .25s ease,background .25s ease,color .25s ease,border-color .25s ease;
      cursor:pointer;
      padding:.35rem;
      overflow:hidden;
      font-family:var(--heading-font);
    }
    .tile .content{display:block;width:100%;padding:0 .35rem;font-weight:600;line-height:1.25;letter-spacing:.06em}
    .tile.hidden .content{color:var(--amber200);font-size:1.75rem;text-transform:uppercase;text-shadow:0 0 12px rgba(0,0,0,.7);font-variant-numeric:tabular-nums}
    .tile.hidden .content::before{content:'$';margin-right:.1em}
    .tile.hidden{color:var(--amber200)}
    .tile.hidden:hover{transform:translateY(-3px);box-shadow:inset 0 0 22px rgba(0,0,0,.45),0 18px 28px rgba(0,0,0,.55);filter:brightness(1.05)}
    .tile.clue{
      background:linear-gradient(150deg,rgba(33,77,204,.95) 0%,rgba(41,102,255,.9) 100%);
      color:#fff;
      border-color:rgba(249,198,66,.75);
      box-shadow:inset 0 0 18px rgba(8,23,89,.65),0 16px 28px rgba(6,18,65,.6);
    }
    .tile.clue .content{font-size:1rem;text-transform:none;letter-spacing:.02em;text-shadow:0 2px 10px rgba(0,0,0,.5)}
    .tile.response{
      background:linear-gradient(150deg,rgba(38,125,230,.95) 0%,rgba(63,177,255,.9) 100%);
      color:#fff;
      border-color:rgba(249,198,66,.7);
      box-shadow:inset 0 0 18px rgba(9,40,96,.55),0 16px 28px rgba(4,17,60,.55);
    }
    .tile.response .content{font-size:1rem;text-transform:none;letter-spacing:.02em;text-shadow:0 2px 10px rgba(0,0,0,.5)}
    .tile.done,.tile[disabled]{background:linear-gradient(180deg,rgba(18,24,54,.85) 0%,rgba(10,14,34,.9) 100%);border-color:rgba(67,78,132,.7);color:rgba(180,190,220,.4);cursor:not-allowed;box-shadow:inset 0 0 18px rgba(0,0,0,.65)}
    .tile:focus-visible{outline:3px solid var(--amber200);outline-offset:4px}
    .value-tag{display:none}
    .played{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1rem;text-transform:uppercase;letter-spacing:.1em;color:rgba(216,226,255,.6)}
    .flash{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;border-radius:18px;background:rgba(27,73,225,.85);color:#fff;text-align:center;padding:.75rem;animation:pulse 1s infinite;text-transform:uppercase;font-family:var(--heading-font);letter-spacing:.08em}
    @keyframes pulse{0%{opacity:.95}50%{opacity:.65}100%{opacity:.95}}

    .tips summary{cursor:pointer}

    /* Modal */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--overlay);padding:1rem;z-index:50}
    .card{width:100%;max-width:42rem;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:1.25rem}
    .final-toggle{margin-top:1rem;padding:1rem;border-radius:12px;background:var(--indigo50);border:1px solid var(--indigo100);cursor:pointer;user-select:none}

    input[type="url"]{padding:.25rem .5rem;border:1px solid #d1d5db;border-radius:6px;font-size:.9rem;width:280px}
    label{font-size:.85rem}
    .status{margin-top:.5rem;font-size:.8rem;font-style:italic;color:#4b5563}
    .control-panel{display:grid;gap:1rem;margin-top:1.5rem}
    @media (min-width:768px){.control-panel{grid-template-columns:2fr 3fr}}
    .panel{padding:1rem;border-radius:16px;border:1px solid rgba(249,198,66,.45);background:rgba(9,22,84,.82);box-shadow:0 18px 36px rgba(0,0,0,.45)}
    .panel h2{margin:0 0 .5rem;font-size:1.125rem;font-family:var(--heading-font);letter-spacing:.08em;text-transform:uppercase;color:var(--amber200)}
    .contestant-list{display:grid;gap:.75rem}
    .contestant{display:flex;justify-content:space-between;align-items:center;padding:.75rem 1rem;border-radius:12px;background:rgba(1,7,32,.75);border:1px solid rgba(255,255,255,.1);box-shadow:0 8px 18px rgba(0,0,0,.35);transition:.2s}
    .contestant.active{border-color:rgba(249,198,66,.7);box-shadow:0 12px 26px rgba(9,22,84,.6);background:rgba(15,36,115,.8)}
    .contestant-name{font-weight:600;font-family:var(--heading-font);letter-spacing:.06em;text-transform:uppercase;color:var(--amber200)}
    .contestant-score{font-variant-numeric:tabular-nums;font-weight:600;font-size:1.05rem;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.6)}
    .buzzer-grid{display:flex;flex-wrap:wrap;gap:.5rem}
    .buzzer-btn{background:rgba(255,255,255,.12);color:var(--text);border:1px solid rgba(255,255,255,.22);box-shadow:0 8px 18px rgba(0,0,0,.3)}
    .buzzer-btn:disabled{opacity:.55;cursor:not-allowed}
    .buzzer-note{margin-top:.25rem;font-size:.8rem;color:var(--muted)}
    .buzzer-status{margin-top:.5rem;font-size:.85rem;font-weight:600}
    .buzzer-indicator{margin-top:.5rem;font-size:1rem;font-weight:600;padding:.5rem .75rem;border-radius:12px;display:none}
    .buzzer-indicator[data-tone="ready"]{display:block;background:rgba(20,140,255,.9);color:#fff}
    .buzzer-indicator[data-tone="active"]{display:block;background:var(--amber200);color:#2f1c00}
    .buzzer-indicator[data-tone="success"]{display:block;background:rgba(34,192,124,.85);color:#012d18}
    .buzzer-indicator[data-tone="warn"]{display:block;background:rgba(196,42,42,.8);color:#fff}
    .buzzer-indicator[data-tone="info"]{display:block;background:rgba(61,96,214,.85);color:#fff}
    .host-controls{margin-top:.75rem;padding:.75rem;border-radius:12px;background:rgba(1,7,32,.75);border:1px dashed rgba(255,255,255,.28)}
    .host-controls h3{margin:0 0 .5rem;font-size:1rem;font-family:var(--heading-font);letter-spacing:.05em;text-transform:uppercase;color:var(--amber200)}
    .host-controls .btn{min-width:6.5rem}
    .host-controls .btn:disabled{opacity:.5;cursor:not-allowed}
    .host-controls.active{border-style:solid;border-color:rgba(249,198,66,.6);box-shadow:0 0 0 2px rgba(249,198,66,.35)}
    body.role-contestant [data-role="host-only"]{display:none !important}
    .host-answer{margin-top:.75rem;padding:.75rem;border-radius:12px;background:rgba(1,7,32,.78);border:1px dashed rgba(255,255,255,.3);display:flex;flex-direction:column;gap:.25rem}
    .host-answer h3{margin:0;font-size:1rem;font-family:var(--heading-font);letter-spacing:.05em;text-transform:uppercase;color:var(--amber200)}
    .host-answer p{margin:0;font-size:.9rem}
    .host-answer[data-state="active"]{border-style:solid;border-color:rgba(32,76,214,.75);box-shadow:0 0 0 2px rgba(41,102,255,.35)}
    @media (max-width:1024px){
      .board-wrapper{max-width:100%;padding:1.25rem 1.25rem 1.75rem}
      .grid{justify-content:flex-start}
    }
    @media (max-width:768px){
      .container{padding:1rem}
      .board-wrapper{margin:0 -1rem 1.25rem;padding:1rem 1.25rem 1.5rem}
    }
    @media (max-width:640px){
      .grid{gap:.5rem;min-width:calc(4 * var(--tile-width) + 1.5rem)}
      .col{gap:.45rem}
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="row" style="justify-content:space-between;align-items:flex-end;margin-bottom:1rem;">
      <div>
        <h1>ESGoepardy â€” 2024 ESG Edition</h1>
        <p class="muted">Click once to reveal the <strong>clue</strong>, click again to reveal the <strong>correct response</strong>. After that, the tile is marked as <strong>Played</strong>.</p>
      </div>
      <div class="row">
        <button id="resetBtn" class="btn btn-primary">Reset Board</button>
        <span id="remainingText" class="muted" style="font-size:.9rem">Remaining tiles: 16</span>
      </div>
    </header>

    <div class="board-wrapper" aria-hidden="false">
      <div id="board" class="grid" aria-label="Jeopardy board"></div>
    </div>

    <section class="control-panel" aria-label="Scoreboard and buzzer controls">
      <div class="panel">
        <h2>Contestants</h2>
        <div id="scoreboardList" class="contestant-list" aria-live="polite"></div>
      </div>
      <div class="panel">
        <h2>Buzzers</h2>
        <p class="buzzer-note">Use the buttons below or press keys <strong>1</strong>, <strong>2</strong>, and <strong>3</strong> to buzz for Contestants 1â€“3.</p>
        <div id="buzzerControls" class="buzzer-grid"></div>
        <div id="buzzerStatus" class="buzzer-status" aria-live="polite">Buzzers locked</div>
        <div id="buzzerIndicator" class="buzzer-indicator" aria-live="assertive"></div>
        <div id="hostControls" class="host-controls" data-role="host-only" hidden>
          <h3>Host Controls</h3>
          <div class="row" style="flex-wrap:wrap;gap:.5rem">
            <button id="markCorrect" class="btn btn-primary" disabled>Correct</button>
            <button id="markIncorrect" class="btn btn-alt" disabled>Incorrect</button>
            <button id="clearBuzz" class="btn btn-alt" disabled>Clear Buzz</button>
            <button id="revealTile" class="btn btn-primary" disabled>Reveal to contestants</button>
          </div>
        </div>
        <div id="hostAnswerPanel" class="host-answer" data-role="host-only" aria-live="polite" hidden>
          <h3>Host Preview</h3>
          <p id="hostAnswerMeta" class="muted">Select a clue to preview the correct response.</p>
          <p id="hostAnswerText" style="font-weight:600"></p>
        </div>
      </div>
    </section>

    <section class="row" style="justify-content:space-between;margin-top:1.25rem;align-items:flex-start;gap:.75rem">
      <div class="tips muted" style="font-size:.9rem" data-role="host-only" hidden>
        <details open>
          <summary>Host tips</summary>
          <ul style="margin:.5rem 0 .25rem 1.25rem">
            <li>Keep pace to ~45s per tile to fit an 8-minute round.</li>
            <li>Read the <strong>clue</strong> aloud; contestants respond in the form of a question.</li>
            <li>Skip around categories to keep energy high.</li>
            <li>Use "Reset Board" to reroll the hidden Double Jeopardy tile.</li>
          </ul>
        </details>
      </div>
      <div class="row" style="gap:.5rem;align-items:center">
        <button id="finalBtn" class="btn" style="background:var(--fuchsia700);color:#fff">Final Jeopardy</button>
        <audio id="final-audio" src="JeopardyMusic.mp3" preload="auto" aria-hidden="true"></audio>
      </div>
    </section>
  </div>

  <!-- Final Jeopardy Modal -->
  <div id="modal" class="modal" style="display:none">
    <div class="card" role="dialog" aria-labelledby="finalTitle" aria-modal="true">
      <div style="text-align:center">
        <div class="muted" style="letter-spacing:.15em;font-size:.8rem">FINAL JEOPARDY</div>
        <div id="finalTitle" style="margin-top:.25rem;font-weight:600;font-size:1.25rem">ESG Theme</div>
      </div>

      <div id="finalToggle" class="final-toggle" role="button" tabindex="0" aria-pressed="false" title="Click to reveal response">
        <p id="finalContent" style="margin:0;font-size:1.125rem;line-height:1.6"></p>
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:.75rem;gap:.5rem;flex-wrap:wrap">
        <button id="revealBtn" class="btn btn-primary">Reveal Response</button>
        <button id="closeBtn" class="btn btn-alt">Close</button>
      </div>

      <p class="muted" style="margin-top:.5rem;font-size:.8rem">Starting Final Jeopardy ends the game and disables the board. Use <strong>Reset Board</strong> to start a new round.</p>
    </div>
  </div>

  <script>
  // -----------------------------
  // Board Content (4 x 4)
  // -----------------------------
  const params = new URLSearchParams(window.location.search);
  const roleParam = params.get('role');
  const IS_HOST = roleParam ? roleParam.toLowerCase()==='host' : true;
  window.IS_HOST = IS_HOST;
  document.body.classList.remove('role-host','role-contestant');
  document.body.classList.add(IS_HOST ? 'role-host' : 'role-contestant');
  document.querySelectorAll('[data-role="host-only"]').forEach(el=>{
    if(IS_HOST){
      el.removeAttribute('hidden');
    } else {
      el.setAttribute('hidden','');
    }
  });

  const BOARD = [
    { category: "Planet Positive ðŸŒ", clues: [
      { value:100, clue:"Turner is working toward this long-term environmental goal, common across the construction industry.", response:"What is Net-Zero Emissions?" },
      { value:200, clue:"This type of material, such as low-carbon concrete or mass timber, is key to reducing embodied carbon.", response:"What are sustainable building materials?" },
      { value:300, clue:"Turnerâ€™s approach to water, waste, and biodiversity shows our commitment to protecting this.", response:"What is the planet (or environment)?" },
      { value:400, clue:"Electrification of fleets, renewable fuels, and green jobsite innovations are part of this broader strategy.", response:"What is decarbonization?" },
    ]},
    { category: "People Power ðŸ‘¥", clues: [
      { value:100, clue:"Turnerâ€™s workplace culture is grounded in this value, which means looking out for one another.", response:"What is Active Caring?" },
      { value:200, clue:"Expanding family leave, wellness programs, and ERGs are all about supporting this.", response:"What is employee well-being?" },
      { value:300, clue:"Mentorship, career pathways, and leadership programs help develop this.", response:"What is the next generation of leaders?" },
      { value:400, clue:"The focus of Construction Inclusion Week, and a key Turner priority, is building a culture of this.", response:"What is inclusion (or belonging)?" },
    ]},
    { category: "Community Impact ðŸ¤", clues: [
      { value:100, clue:"Turner partners with local schools, nonprofits, and trade groups to invest in this.", response:"What is the community (or future workforce)?" },
      { value:200, clue:"Food drives, volunteer days, and building gardens are examples of this type of impact.", response:"What is community service (or engagement)?" },
      { value:300, clue:"Programs like ACE Extern and YouthConstruct help young people explore careers in this industry.", response:"What is construction?" },
      { value:400, clue:"Turnerâ€™s partnerships with small and diverse businesses strengthen this aspect of local economies.", response:"What is economic development?" },
    ]},
    { category: "Transforming Industry ðŸ—ï¸", clues: [
      { value:100, clue:"Turner has a long history of â€˜firstsâ€™ â€” like being a founding member of this green building council.", response:"What is the U.S. Green Building Council?" },
      { value:200, clue:"Innovation summits, AI pilots, and Turner Ventures all help Turner drive this.", response:"What is industry transformation (or innovation)?" },
      { value:300, clue:"Transparency, ethics, and ISO certifications demonstrate Turnerâ€™s commitment to this.", response:"What is good governance?" },
      { value:400, clue:"Collaborating with clients, partners, and global affiliates helps Turner do this across the construction industry.", response:"What is lead change (or set industry standards)?" },
    ]}
  ];

  const FINAL = {
    clue: "This is Turnerâ€™s guiding vision that connects caring for people, communities, and the planet with building a better future.",
    response: "What is Building Today to Transform Tomorrowâ„¢?",
  };

  const ALLOWED_STATES = new Set(["hidden","clue","response","done"]);
  const nextState = (s)=> s==="hidden"?"clue":(s==="clue"?"response":(s==="response"?"done":"done"));
  const pickRandomTile = ()=>({ col: Math.floor(Math.random()*BOARD.length), row: Math.floor(Math.random()*BOARD[0].clues.length) });

  const CONTESTANTS = [
    { id: 'contestant-1', name: 'Contestant 1', key: '1', score: 0 },
    { id: 'contestant-2', name: 'Contestant 2', key: '2', score: 0 },
    { id: 'contestant-3', name: 'Contestant 3', key: '3', score: 0 },
  ];

  // State
  let states = BOARD.map(col=>col.clues.map(()=>"hidden"));
  let doublePos = pickRandomTile();
  let flashingPos = null; // {col,row}
  let gameEnded = false;
  let showFinal = false;
  let finalRevealed = false;
  let activeTile = null; // {col,row}
  let buzzersEnabled = false;
  let currentResponder = null;
  let hostPreviewTile = null;

  // DOM refs
  const boardEl = document.getElementById('board');
  const remainingText = document.getElementById('remainingText');
  const resetBtn = document.getElementById('resetBtn');
  const finalBtn = document.getElementById('finalBtn');
  const audio = document.getElementById('final-audio');

  const modal = document.getElementById('modal');
  const finalToggle = document.getElementById('finalToggle');
  const finalContent = document.getElementById('finalContent');
  const revealBtn = document.getElementById('revealBtn');
  const closeBtn = document.getElementById('closeBtn');
  const scoreboardList = document.getElementById('scoreboardList');
  const buzzerControls = document.getElementById('buzzerControls');
  const buzzerStatus = document.getElementById('buzzerStatus');
  const buzzerIndicator = document.getElementById('buzzerIndicator');
  const hostControls = document.getElementById('hostControls');
  const markCorrectBtn = document.getElementById('markCorrect');
  const markIncorrectBtn = document.getElementById('markIncorrect');
  const clearBuzzBtn = document.getElementById('clearBuzz');
  const revealTileBtn = document.getElementById('revealTile');
  const hostAnswerPanel = document.getElementById('hostAnswerPanel');
  const hostAnswerMeta = document.getElementById('hostAnswerMeta');
  const hostAnswerText = document.getElementById('hostAnswerText');

  const contestantEls = new Map();
  const scoreEls = new Map();
  const buzzerBtnEls = new Map();
  const keyToContestant = new Map();

  const CLIENT_ID = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
  const CHANNEL_NAME = 'esg-jeopardy-sync';
  const STORAGE_KEY = `__${CHANNEL_NAME}`;
  const broadcastChannel = typeof BroadcastChannel === 'function' ? new BroadcastChannel(CHANNEL_NAME) : null;

  if(broadcastChannel){
    broadcastChannel.onmessage = (event)=>{
      const data = event && event.data;
      if(!data || data.senderId === CLIENT_ID) return;
      handleSyncMessage(data);
    };
  } else {
    window.addEventListener('storage', (event)=>{
      if(event.key !== STORAGE_KEY || !event.newValue) return;
      try{
        const data = JSON.parse(event.newValue);
        if(!data || data.senderId === CLIENT_ID) return;
        handleSyncMessage(data);
      }catch(e){
        console.warn('Failed to parse sync message', e);
      }
    });
  }

  function broadcast(type,payload){
    if(!IS_HOST) return;
    const message = { senderId: CLIENT_ID, type, payload, ts: Date.now() };
    if(broadcastChannel){
      try{ broadcastChannel.postMessage(message); }catch(e){ console.warn('Broadcast channel failed', e); }
    } else {
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(message));
        localStorage.removeItem(STORAGE_KEY);
      }catch(e){
        console.warn('LocalStorage broadcast failed', e);
      }
    }
  }

  function broadcastScores(){
    broadcast('scores',{contestants: CONTESTANTS.map(({id,score})=>({id,score}))});
  }

  function formatScore(value){
    try{
      return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(value);
    }catch(_){
      return `$${value}`;
    }
  }

  function setIndicator(message,tone='info'){
    if(!message){
      buzzerIndicator.textContent = '';
      buzzerIndicator.removeAttribute('data-tone');
      buzzerIndicator.style.display = 'none';
      return;
    }
    buzzerIndicator.textContent = message;
    buzzerIndicator.dataset.tone = tone;
    buzzerIndicator.style.display = 'block';
  }

  function setHostPreview(colIdx,rowIdx,item){
    if(!hostAnswerPanel || !hostAnswerMeta || !hostAnswerText) return;
    hostPreviewTile = {col:colIdx,row:rowIdx};
    hostAnswerPanel.dataset.state = 'active';
    const valueLabel = item && typeof item.value === 'number' ? formatScore(item.value) : '';
    hostAnswerMeta.textContent = `${BOARD[colIdx].category}${valueLabel ? ` â€” ${valueLabel}` : ''}`;
    hostAnswerText.textContent = item ? item.response : '';
  }

  function clearHostPreview(){
    if(!hostAnswerPanel || !hostAnswerMeta || !hostAnswerText) return;
    hostPreviewTile = null;
    hostAnswerPanel.removeAttribute('data-state');
    hostAnswerMeta.textContent = 'Select a clue to preview the correct response.';
    hostAnswerText.textContent = '';
  }

  function updateHostControls(){
    const hasResponder = !!currentResponder;
    [markCorrectBtn,markIncorrectBtn,clearBuzzBtn].forEach(btn=>{ if(btn) btn.disabled = !hasResponder; });
    if(hostControls) hostControls.classList.toggle('active', hasResponder);
    if(revealTileBtn){
      const canReveal = !!activeTile && states[activeTile.col][activeTile.row]==='clue';
      revealTileBtn.disabled = !canReveal;
    }
  }

  function updateContestantDisplay(){
    CONTESTANTS.forEach(contestant=>{
      const row = contestantEls.get(contestant.id);
      const scoreEl = scoreEls.get(contestant.id);
      if(scoreEl) scoreEl.textContent = formatScore(contestant.score);
      if(row) row.classList.toggle('active', !!currentResponder && currentResponder.id===contestant.id);
    });
  }

  function applyScores(data){
    if(!Array.isArray(data)) return;
    data.forEach(item=>{
      if(!item) return;
      const contestant = CONTESTANTS.find(c=>c.id===item.id);
      if(contestant && typeof item.score === 'number'){
        contestant.score = item.score;
      }
    });
    updateContestantDisplay();
  }

  function disableBuzzers(message='Buzzers locked'){
    buzzersEnabled = false;
    buzzerBtnEls.forEach(btn=>{ btn.disabled = true; });
    buzzerStatus.textContent = message;
  }

  function enableBuzzers(message='Buzzers ready (keys 1-3)'){
    if(gameEnded || !activeTile) return;
    buzzersEnabled = true;
    buzzerBtnEls.forEach(btn=>{ btn.disabled = false; });
    buzzerStatus.textContent = message;
  }

  function resetBuzzerSystem(){
    activeTile = null;
    currentResponder = null;
    disableBuzzers('Buzzers locked');
    setIndicator('');
    updateContestantDisplay();
    updateHostControls();
  }

  function prepareBuzzersForClue(){
    if(!activeTile || gameEnded) return;
    currentResponder = null;
    updateContestantDisplay();
    updateHostControls();
    enableBuzzers();
    setIndicator('Buzzers open. Awaiting a contestant.', 'ready');
  }

  function handleBuzzerStateForTile(colIdx,rowIdx,state){
    if(state==='clue'){
      activeTile = {col:colIdx,row:rowIdx};
      prepareBuzzersForClue();
      return;
    }

    if(!activeTile || activeTile.col!==colIdx || activeTile.row!==rowIdx) return;

    if(state==='hidden'){
      resetBuzzerSystem();
    } else if(state==='response'){
      disableBuzzers('Buzzers locked');
      if(!currentResponder) setIndicator('Clue resolved.', 'info');
      currentResponder = null;
      updateContestantDisplay();
      updateHostControls();
    } else if(state==='done'){
      activeTile = null;
    }
  }

  function buildContestantUI(){
    contestantEls.clear();
    scoreEls.clear();
    buzzerBtnEls.clear();
    keyToContestant.clear();
    scoreboardList.innerHTML = '';
    buzzerControls.innerHTML = '';

    CONTESTANTS.forEach(contestant=>{
      const row = document.createElement('div');
      row.className = 'contestant';
      row.dataset.contestantId = contestant.id;
      const nameEl = document.createElement('span');
      nameEl.className = 'contestant-name';
      nameEl.textContent = contestant.name;
      const scoreEl = document.createElement('span');
      scoreEl.className = 'contestant-score';
      scoreEl.textContent = formatScore(contestant.score);
      row.appendChild(nameEl);
      row.appendChild(scoreEl);
      scoreboardList.appendChild(row);
      contestantEls.set(contestant.id,row);
      scoreEls.set(contestant.id,scoreEl);

      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'btn buzzer-btn';
      button.textContent = `${contestant.name} (${contestant.key})`;
      button.setAttribute('aria-label', `Buzz for ${contestant.name} (key ${contestant.key})`);
      button.addEventListener('click', ()=>handleBuzz(contestant));
      buzzerControls.appendChild(button);
      buzzerBtnEls.set(contestant.id,button);

      keyToContestant.set(contestant.key,contestant);
      keyToContestant.set(String(contestant.key).toLowerCase(),contestant);
      keyToContestant.set(String(contestant.key).toUpperCase(),contestant);
    });

    disableBuzzers('Buzzers locked');
    setIndicator('');
    updateHostControls();
  }

  function handleBuzz(contestant){
    if(gameEnded || !buzzersEnabled || currentResponder || !activeTile) return;
    currentResponder = contestant;
    disableBuzzers('Buzzers locked');
    updateContestantDisplay();
    updateHostControls();
    setIndicator(`${contestant.name} buzzed in!`, 'active');
  }

  function handleCorrect(){
    if(!currentResponder || !activeTile) return;
    const contestant = currentResponder;
    const value = BOARD[activeTile.col].clues[activeTile.row].value || 0;
    contestant.score += value;
    currentResponder = null;
    updateContestantDisplay();
    updateHostControls();
    disableBuzzers('Buzzers locked');
    setIndicator(`${contestant.name} is correct! Reveal when ready.`, 'success');
    broadcastScores();
  }

  function handleIncorrect(){
    if(!currentResponder || !activeTile) return;
    const contestant = currentResponder;
    const value = BOARD[activeTile.col].clues[activeTile.row].value || 0;
    contestant.score -= value;
    currentResponder = null;
    updateContestantDisplay();
    updateHostControls();
    enableBuzzers('Buzzers reopened');
    setIndicator(`${contestant.name} is incorrect. Buzzers reopened.`, 'warn');
    broadcastScores();
  }

  function handleClear(){
    if(!currentResponder || !activeTile) return;
    const name = currentResponder.name;
    currentResponder = null;
    updateContestantDisplay();
    updateHostControls();
    enableBuzzers('Buzzers reopened');
    setIndicator(`Buzz cleared for ${name}. Awaiting buzz.`, 'info');
  }

  function revealActiveTile(options={}){
    const fromSync = !!options.fromSync;
    const colIdx = options.colIdx ?? (activeTile && activeTile.col);
    const rowIdx = options.rowIdx ?? (activeTile && activeTile.row);
    if(colIdx===undefined || rowIdx===undefined) return;
    if(IS_HOST && !fromSync) broadcast('revealTile',{colIdx,rowIdx});
    setTileState(colIdx,rowIdx,'response',options);
    setTileState(colIdx,rowIdx,'done',options);
    updateRemaining();
  }

  function handleSyncMessage(message){
    if(!message || typeof message !== 'object') return;
    const { type, payload } = message;
    switch(type){
      case 'advanceTile':
        if(payload) advanceTile(payload.colIdx,payload.rowIdx,{fromSync:true});
        break;
      case 'setTileState':
        if(payload) setTileState(payload.colIdx,payload.rowIdx,payload.state,{fromSync:true,broadcast:false});
        updateRemaining();
        break;
      case 'scores':
        if(payload) applyScores(payload.contestants);
        break;
      case 'resetBoard':
        resetBoard({fromSync:true});
        break;
      case 'openFinal':
        openFinal({fromSync:true});
        break;
      case 'closeFinal':
        closeFinal({fromSync:true});
        break;
      case 'toggleFinal':
        if(payload && Object.prototype.hasOwnProperty.call(payload,'force')){
          toggleFinal({fromSync:true, force: payload.force});
        } else {
          toggleFinal({fromSync:true});
        }
        break;
      case 'revealTile':
        if(payload) revealActiveTile({fromSync:true,colIdx:payload.colIdx,rowIdx:payload.rowIdx});
        break;
      default:
        break;
    }
  }

  // Build Board DOM once
  const colEls = [];
  const tileBtn = (colIdx,rowIdx)=>document.getElementById(`tile-${colIdx}-${rowIdx}`);

  function buildBoard(){
    boardEl.innerHTML = '';
    BOARD.forEach((column, colIdx)=>{
      const col = document.createElement('div');
      col.className = 'col';
      const cat = document.createElement('div');
      cat.className = 'cat';
      cat.textContent = column.category;
      col.appendChild(cat);

      column.clues.forEach((item,rowIdx)=>{
        const btn = document.createElement('button');
        btn.id = `tile-${colIdx}-${rowIdx}`;
        btn.className = 'tile hidden';
        btn.setAttribute('aria-label', `Reveal ${item.value} clue`);
        btn.addEventListener('click', ()=>advanceTile(colIdx,rowIdx));
        const content = document.createElement('span');
        content.className = 'content';
        content.style.display = 'block';
        content.style.fontWeight = '600';
        content.style.fontSize = '1.125rem';
        content.style.lineHeight = '1.25';
        content.textContent = item.value;
        btn.appendChild(content);
        const tag = document.createElement('span');
        tag.className = 'value-tag';
        tag.textContent = item.value;
        btn.appendChild(tag);
        col.appendChild(btn);
      });

      colEls.push(col);
      boardEl.appendChild(col);
    });
    updateRemaining();
  }

  function updateRemaining(){
    const remaining = states.flat().filter(s=>s!=="done").length;
    remainingText.textContent = `Remaining tiles: ${remaining}`;
  }

  function setTileState(colIdx,rowIdx,state,options){
    options = options || {};
    states[colIdx][rowIdx] = state;
    const btn = tileBtn(colIdx,rowIdx);
    const item = BOARD[colIdx].clues[rowIdx];
    const content = btn.querySelector('.content');
    btn.classList.remove('hidden','clue','response','done');
    btn.classList.add(state);

    if(state==='hidden'){
      content.textContent = item.value;
      btn.querySelector('.value-tag').style.display = '';
      btn.disabled = false;
      btn.setAttribute('aria-label',`Reveal ${item.value} clue`);
    } else if(state==='clue'){
      content.textContent = item.clue;
      btn.querySelector('.value-tag').style.display = 'none';
      btn.disabled = false;
      btn.setAttribute('aria-label','Reveal correct response');
    } else if(state==='response'){
      content.textContent = item.response;
      btn.querySelector('.value-tag').style.display = 'none';
      btn.disabled = false;
      btn.setAttribute('aria-label','Played');
    } else { // done
      content.innerHTML = '<span class="played">Played</span>';
      btn.querySelector('.value-tag').style.display = 'none';
      btn.disabled = true;
      btn.setAttribute('aria-label','Played');
    }

    handleBuzzerStateForTile(colIdx,rowIdx,state);
    if(state==='clue'){
      setHostPreview(colIdx,rowIdx,item);
    } else if(hostPreviewTile && hostPreviewTile.col===colIdx && hostPreviewTile.row===rowIdx){
      clearHostPreview();
    }
    if(IS_HOST) updateHostControls();
    if(IS_HOST && options.broadcast !== false && !options.fromSync){
      broadcast('setTileState',{colIdx,rowIdx,state});
    }
  }

  function isFlashingAt(colIdx,rowIdx){
    return !!flashingPos && flashingPos.col===colIdx && flashingPos.row===rowIdx;
  }

  function setFlashing(colIdx,rowIdx,enable){
    const btn = tileBtn(colIdx,rowIdx);
    if(enable){
      const overlay = document.createElement('div');
      overlay.className = 'flash';
      overlay.innerHTML = '<div><div style="font-size:.75rem;letter-spacing:.25em">DOUBLE</div><div style="font-weight:800;font-size:1.5rem;line-height:1">JEOPARDY!</div></div>';
      overlay.dataset.flash = '1';
      btn.appendChild(overlay);
      btn.disabled = true;
    } else {
      const overlay = btn.querySelector('.flash');
      if(overlay) overlay.remove();
      btn.disabled = false;
    }
  }

  function isDoubleAt(colIdx,rowIdx){
    return doublePos && doublePos.col===colIdx && doublePos.row===rowIdx;
  }

  function advanceTile(colIdx,rowIdx,options={}){
    const fromSync = !!options.fromSync;
    if(!fromSync && !IS_HOST) return;
    if(gameEnded && !fromSync) return;
    const currentState = states[colIdx][rowIdx];
    if(!fromSync && currentState==='clue') return; // wait for explicit reveal control
    if(IS_HOST && !fromSync) broadcast('advanceTile',{colIdx,rowIdx});

    // Double Jeopardy behaviour
    if(isDoubleAt(colIdx,rowIdx)){
      if(currentState==='hidden'){
        flashingPos = {col:colIdx,row:rowIdx};
        setFlashing(colIdx,rowIdx,true);
        setTimeout(()=>{
          setFlashing(colIdx,rowIdx,false);
          flashingPos = null;
          setTileState(colIdx,rowIdx,'clue',options);
          updateRemaining();
        },2000);
        return;
      }
    }

    // Regular flow
    const next = nextState(currentState);
    setTileState(colIdx,rowIdx,next,options);
    updateRemaining();
  }

  function resetBoard(options={}){
    const fromSync = !!options.fromSync;
    states = BOARD.map(col=>col.clues.map(()=>"hidden"));
    flashingPos = null;
    doublePos = pickRandomTile();
    gameEnded = false;
    showFinal = false;
    finalRevealed = false;
    CONTESTANTS.forEach(contestant=>{ contestant.score = 0; });
    resetBuzzerSystem();
    try{ audio.pause(); audio.currentTime = 0; }catch(e){}
    // Re-render tiles
    BOARD.forEach((col,ci)=>col.clues.forEach((_,ri)=>setTileState(ci,ri,'hidden',{broadcast:false})));
    updateContestantDisplay();
    clearHostPreview();
    updateHostControls();
    updateRemaining();
    if(IS_HOST && !fromSync){
      broadcast('resetBoard',{});
      broadcastScores();
    }
  }

  const DEFAULT_FINAL_SRC = 'JeopardyMusic.mp3';

  async function openFinal(options={}){
    const fromSync = !!options.fromSync;
    gameEnded = true; // disables board via disabled attr set when reaching 'done' only; we prevent clicks by short-circuit
    showFinal = true;
    finalRevealed = false;
    resetBuzzerSystem();
    clearHostPreview();
    setIndicator('Final Jeopardy in progress. Buzzers disabled.', 'info');
    finalContent.textContent = FINAL.clue;
    finalToggle.setAttribute('aria-pressed','false');
    revealBtn.style.display = '';
    modal.style.display = 'flex';
    if(IS_HOST && !fromSync){
      broadcast('openFinal',{});
    }
    try{
      audio.src = DEFAULT_FINAL_SRC;
      audio.currentTime = 0;
      audio.loop = true;
      await audio.play();
    }catch(e){
      console.warn('Final Jeopardy audio playback failed:', e);
    }
  }
  function closeFinal(options={}){
    const fromSync = !!options.fromSync;
    modal.style.display = 'none';
    showFinal = false;
    if(IS_HOST && !fromSync){
      broadcast('closeFinal',{});
    }
    try{ audio.pause(); audio.currentTime = 0; }catch(e){}
  }
  function toggleFinal(options={}){
    const fromSync = !!options.fromSync;
    if(Object.prototype.hasOwnProperty.call(options,'force')){
      finalRevealed = !!options.force;
    } else {
      finalRevealed = !finalRevealed;
    }
    finalContent.textContent = finalRevealed ? FINAL.response : FINAL.clue;
    finalToggle.setAttribute('aria-pressed', String(finalRevealed));
    revealBtn.style.display = finalRevealed ? 'none' : '';
    if(IS_HOST && !fromSync){
      broadcast('toggleFinal',{force: finalRevealed});
    }
  }

  // Wire up controls
  resetBtn.addEventListener('click', ()=>{ if(!IS_HOST) return; resetBoard(); });
  finalBtn.addEventListener('click', ()=>{ if(!IS_HOST) return; openFinal(); });
  closeBtn.addEventListener('click', ()=>{ if(!IS_HOST) return; closeFinal(); });
  revealBtn.addEventListener('click', ()=>{ if(!IS_HOST || finalRevealed) return; toggleFinal(); });
  finalToggle.addEventListener('click', ()=>{ if(!IS_HOST) return; toggleFinal(); });
  finalToggle.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); if(!IS_HOST) return; toggleFinal(); }});
  if(revealTileBtn) revealTileBtn.addEventListener('click', ()=>{ if(!IS_HOST) return; revealActiveTile(); });
  markCorrectBtn.addEventListener('click', ()=>{ if(!IS_HOST) return; handleCorrect(); });
  markIncorrectBtn.addEventListener('click', ()=>{ if(!IS_HOST) return; handleIncorrect(); });
  clearBuzzBtn.addEventListener('click', ()=>{ if(!IS_HOST) return; handleClear(); });

  document.addEventListener('keydown',(event)=>{
    if(event.repeat) return;
    const activeTag = (document.activeElement && document.activeElement.tagName) ? document.activeElement.tagName.toUpperCase() : '';
    if(activeTag==='INPUT' || activeTag==='TEXTAREA') return;
    const contestant = keyToContestant.get(event.key);
    if(!contestant) return;
    event.preventDefault();
    handleBuzz(contestant);
  });

  // Build once and init states
  buildContestantUI();
  buildBoard();
  // Initialize each tile explicitly so content matches state
  BOARD.forEach((col,ci)=>col.clues.forEach((_,ri)=>setTileState(ci,ri,'hidden',{broadcast:false})));

  // Minimal runtime assertions in console (dev aid)
  try{
    console.assert(Array.isArray(BOARD)&&BOARD.length===4,'[TEST] Expected 4 categories');
    BOARD.forEach((c,i)=>{ console.assert(Array.isArray(c.clues)&&c.clues.length===4,`[TEST] Expected 4 clues in column ${i}`); });
    console.assert(ALLOWED_STATES.has(states[0][0]), '[TEST] Valid state');
  }catch(e){ console.warn('[TEST] Runtime assertions raised:',e); }
  </script>
</body>
</html>
