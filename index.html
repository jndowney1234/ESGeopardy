<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESGeopardy — 2024 ESG Edition (Static)</title>
  <style>
    :root{
      --bg:#ffffff;--text:#111827;--muted:#6b7280;--indigo50:#eef2ff;--indigo100:#e0e7ff;
      --blue700:#1d4ed8;--blue800:#1e40af;--amber200:#fde68a;--amber300:#fcd34d;--emerald100:#d1fae5;--emerald200:#a7f3d0;
      --gray200:#e5e7eb;--gray300:#d1d5db;--fuchsia700:#a21caf;--overlay:rgba(0,0,0,.5);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;}
    .container{max-width:72rem;margin:0 auto;padding:1.5rem}
    h1{font-size:1.875rem;line-height:2.25rem;margin:0 0 .25rem;font-weight:700}
    p{margin:.25rem 0}
    .muted{color:var(--muted)}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:0;border-radius:12px;padding:.5rem 1rem;cursor:pointer;font-weight:600}
    .btn-primary{background:#111827;color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.15)}
    .btn-primary:hover{box-shadow:0 6px 12px rgba(0,0,0,.18)}
    .btn-alt{background:var(--gray200)}
    .grid{display:grid;grid-template-columns:1fr;gap:.75rem}
    @media (min-width:640px){.grid{grid-template-columns:repeat(4,minmax(0,1fr))}}
    .col{display:flex;flex-direction:column;gap:.75rem}
    .cat{padding:.75rem;text-align:center;border:1px solid var(--indigo100);background:var(--indigo50);border-radius:16px;font-weight:600}
    .tile{position:relative;min-height:110px;padding:.75rem;border-radius:16px;text-align:center;border:1px solid transparent;transition:.15s;cursor:pointer}
    .tile.hidden{background:var(--blue700);color:#fff;border-color:var(--blue800)}
    .tile.hidden:hover{filter:brightness(.95)}
    .tile.clue{background:var(--amber200);color:#111827;border-color:var(--amber300)}
    .tile.clue:hover{filter:brightness(.98)}
    .tile.response{background:var(--emerald100);color:#111827;border-color:var(--emerald200)}
    .tile.response:hover{filter:brightness(.98)}
    .tile.done,.tile[disabled]{background:var(--gray200);border-color:var(--gray300);color:#9ca3af;cursor:not-allowed}
    .value-tag{position:absolute;right:.75rem;bottom:.5rem;opacity:.8;font-size:.875rem}
    .played{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:.9rem}
    .flash{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;border-radius:16px;background:rgba(162,28,175,.9);color:#fff;text-align:center;padding:.75rem;animation:pulse 1s infinite}
    @keyframes pulse{0%{opacity:.95}50%{opacity:.65}100%{opacity:.95}}

    .tips summary{cursor:pointer}

    /* Modal */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--overlay);padding:1rem;z-index:50}
    .card{width:100%;max-width:42rem;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:1.25rem}
    .final-toggle{margin-top:1rem;padding:1rem;border-radius:12px;background:var(--indigo50);border:1px solid var(--indigo100);cursor:pointer;user-select:none}

    input[type="url"]{padding:.25rem .5rem;border:1px solid #d1d5db;border-radius:6px;font-size:.9rem;width:280px}
    label{font-size:.85rem}
    .status{margin-top:.5rem;font-size:.8rem;font-style:italic;color:#4b5563}
    .control-panel{display:grid;gap:1rem;margin-top:1.5rem}
    @media (min-width:768px){.control-panel{grid-template-columns:2fr 3fr}}
    .panel{padding:1rem;border-radius:16px;border:1px solid var(--indigo100);background:var(--indigo50)}
    .panel h2{margin:0 0 .5rem;font-size:1.125rem}
    .contestant-list{display:grid;gap:.5rem}
    .contestant{display:flex;justify-content:space-between;align-items:center;padding:.75rem 1rem;border-radius:12px;background:#fff;border:1px solid var(--gray200);box-shadow:0 1px 2px rgba(15,23,42,.08);transition:.15s}
    .contestant.active{border-color:var(--amber300);box-shadow:0 4px 10px rgba(252,211,77,.35);background:var(--amber200)}
    .contestant-name{font-weight:600}
    .contestant-score{font-variant-numeric:tabular-nums;font-weight:600}
    .buzzer-grid{display:flex;flex-wrap:wrap;gap:.5rem}
    .buzzer-btn{background:#fff;color:var(--text);border:1px solid var(--gray300);box-shadow:0 1px 2px rgba(15,23,42,.08)}
    .buzzer-btn:disabled{opacity:.55;cursor:not-allowed}
    .buzzer-note{margin-top:.25rem;font-size:.8rem;color:var(--muted)}
    .buzzer-status{margin-top:.5rem;font-size:.85rem;font-weight:600}
    .buzzer-indicator{margin-top:.5rem;font-size:1rem;font-weight:600;padding:.5rem .75rem;border-radius:12px;display:none}
    .buzzer-indicator[data-tone="ready"]{display:block;background:var(--emerald100);color:#065f46}
    .buzzer-indicator[data-tone="active"]{display:block;background:var(--amber200);color:#78350f}
    .buzzer-indicator[data-tone="success"]{display:block;background:var(--emerald100);color:#065f46}
    .buzzer-indicator[data-tone="warn"]{display:block;background:#fee2e2;color:#991b1b}
    .buzzer-indicator[data-tone="info"]{display:block;background:#e0e7ff;color:var(--blue800)}
    .host-controls{margin-top:.75rem;padding:.75rem;border-radius:12px;background:#fff;border:1px dashed var(--gray300)}
    .host-controls h3{margin:0 0 .5rem;font-size:1rem}
    .host-controls .btn{min-width:6.5rem}
    .host-controls .btn:disabled{opacity:.5;cursor:not-allowed}
    .host-controls.active{border-style:solid;border-color:var(--amber300);box-shadow:0 0 0 2px rgba(252,211,77,.35)}
    body.role-contestant [data-role="host-only"]{display:none !important}
    .host-answer{margin-top:.75rem;padding:.75rem;border-radius:12px;background:#fff;border:1px dashed var(--gray300);display:flex;flex-direction:column;gap:.25rem}
    .host-answer h3{margin:0;font-size:1rem}
    .host-answer p{margin:0;font-size:.9rem}
    .host-answer[data-state="active"]{border-style:solid;border-color:var(--blue700);box-shadow:0 0 0 2px rgba(29,78,216,.25)}
  </style>
</head>
<body>
  <div class="container">
    <header class="row" style="justify-content:space-between;align-items:flex-end;margin-bottom:1rem;">
      <div>
        <h1>ESGeopardy — 2024 ESG Edition</h1>
        <p class="muted">Click once to reveal the <strong>clue</strong>, click again to reveal the <strong>correct response</strong>. After that, the tile is marked as <strong>Played</strong>.</p>
      </div>
      <div class="row">
        <button id="resetBtn" class="btn btn-primary">Reset Board</button>
        <span id="remainingText" class="muted" style="font-size:.9rem">Remaining tiles: 16</span>
      </div>
    </header>

    <div id="board" class="grid" aria-label="Jeopardy board"></div>

    <section class="control-panel" aria-label="Scoreboard and buzzer controls">
      <div class="panel">
        <h2>Contestants</h2>
        <div id="scoreboardList" class="contestant-list" aria-live="polite"></div>
      </div>
      <div class="panel">
        <h2>Buzzers</h2>
        <p class="buzzer-note">Use the buttons below or press keys <strong>1</strong>, <strong>2</strong>, and <strong>3</strong> to buzz for Contestants 1–3.</p>
        <div id="buzzerControls" class="buzzer-grid"></div>
        <div id="buzzerStatus" class="buzzer-status" aria-live="polite">Buzzers locked</div>
        <div id="buzzerIndicator" class="buzzer-indicator" aria-live="assertive"></div>
        <div id="hostControls" class="host-controls" data-role="host-only" hidden>
          <h3>Host Controls</h3>
          <div class="row" style="flex-wrap:wrap;gap:.5rem">
            <button id="markCorrect" class="btn btn-primary" disabled>Correct</button>
            <button id="markIncorrect" class="btn btn-alt" disabled>Incorrect</button>
            <button id="clearBuzz" class="btn btn-alt" disabled>Clear Buzz</button>
            <button id="revealTile" class="btn btn-primary" disabled>Reveal to contestants</button>
          </div>
        </div>
        <div id="hostAnswerPanel" class="host-answer" data-role="host-only" aria-live="polite" hidden>
          <h3>Host Preview</h3>
          <p id="hostAnswerMeta" class="muted">Select a clue to preview the correct response.</p>
          <p id="hostAnswerText" style="font-weight:600"></p>
        </div>
      </div>
    </section>

    <section class="row" style="justify-content:space-between;margin-top:1.25rem;align-items:flex-start;gap:.75rem">
      <div class="tips muted" style="font-size:.9rem" data-role="host-only" hidden>
        <details open>
          <summary>Host tips</summary>
          <ul style="margin:.5rem 0 .25rem 1.25rem">
            <li>Keep pace to ~45s per tile to fit an 8-minute round.</li>
            <li>Read the <strong>clue</strong> aloud; contestants respond in the form of a question.</li>
            <li>Skip around categories to keep energy high.</li>
            <li>Use "Reset Board" to reroll the hidden Double Jeopardy tile.</li>
          </ul>
        </details>
      </div>
      <div class="row" style="gap:.5rem;align-items:center">
        <button id="finalBtn" class="btn" style="background:var(--fuchsia700);color:#fff">Final Jeopardy</button>
        <audio id="final-audio" src="JeopardyMusic.mp3" preload="auto" aria-hidden="true"></audio>
      </div>
    </section>
  </div>

  <!-- Final Jeopardy Modal -->
  <div id="modal" class="modal" style="display:none">
    <div class="card" role="dialog" aria-labelledby="finalTitle" aria-modal="true">
      <div style="text-align:center">
        <div class="muted" style="letter-spacing:.15em;font-size:.8rem">FINAL JEOPARDY</div>
        <div id="finalTitle" style="margin-top:.25rem;font-weight:600;font-size:1.25rem">ESG Theme</div>
      </div>

      <div id="finalToggle" class="final-toggle" role="button" tabindex="0" aria-pressed="false" title="Click to reveal response">
        <p id="finalContent" style="margin:0;font-size:1.125rem;line-height:1.6"></p>
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:.75rem;gap:.5rem;flex-wrap:wrap">
        <button id="revealBtn" class="btn btn-primary">Reveal Response</button>
        <button id="closeBtn" class="btn btn-alt">Close</button>
      </div>

      <p class="muted" style="margin-top:.5rem;font-size:.8rem">Starting Final Jeopardy ends the game and disables the board. Use <strong>Reset Board</strong> to start a new round.</p>
    </div>
  </div>

  <script>
  // -----------------------------
  // Board Content (4 x 4)
  // -----------------------------
  const params = new URLSearchParams(window.location.search);
  const roleParam = params.get('role');
  const IS_HOST = roleParam ? roleParam.toLowerCase()==='host' : true;
  window.IS_HOST = IS_HOST;
  document.body.classList.remove('role-host','role-contestant');
  document.body.classList.add(IS_HOST ? 'role-host' : 'role-contestant');
  document.querySelectorAll('[data-role="host-only"]').forEach(el=>{
    if(IS_HOST){
      el.removeAttribute('hidden');
    } else {
      el.setAttribute('hidden','');
    }
  });

  const BOARD = [
    { category: "Planet Positive 🌍", clues: [
      { value:100, clue:"Turner is working toward this long-term environmental goal, common across the construction industry.", response:"What is Net-Zero Emissions?" },
      { value:200, clue:"This type of material, such as low-carbon concrete or mass timber, is key to reducing embodied carbon.", response:"What are sustainable building materials?" },
      { value:300, clue:"Turner’s approach to water, waste, and biodiversity shows our commitment to protecting this.", response:"What is the planet (or environment)?" },
      { value:400, clue:"Electrification of fleets, renewable fuels, and green jobsite innovations are part of this broader strategy.", response:"What is decarbonization?" },
    ]},
    { category: "People Power 👥", clues: [
      { value:100, clue:"Turner’s workplace culture is grounded in this value, which means looking out for one another.", response:"What is Active Caring?" },
      { value:200, clue:"Expanding family leave, wellness programs, and ERGs are all about supporting this.", response:"What is employee well-being?" },
      { value:300, clue:"Mentorship, career pathways, and leadership programs help develop this.", response:"What is the next generation of leaders?" },
      { value:400, clue:"The focus of Construction Inclusion Week, and a key Turner priority, is building a culture of this.", response:"What is inclusion (or belonging)?" },
    ]},
    { category: "Community Impact 🤝", clues: [
      { value:100, clue:"Turner partners with local schools, nonprofits, and trade groups to invest in this.", response:"What is the community (or future workforce)?" },
      { value:200, clue:"Food drives, volunteer days, and building gardens are examples of this type of impact.", response:"What is community service (or engagement)?" },
      { value:300, clue:"Programs like ACE Extern and YouthConstruct help young people explore careers in this industry.", response:"What is construction?" },
      { value:400, clue:"Turner’s partnerships with small and diverse businesses strengthen this aspect of local economies.", response:"What is economic development?" },
    ]},
    { category: "Transforming Industry 🏗️", clues: [
      { value:100, clue:"Turner has a long history of ‘firsts’ — like being a founding member of this green building council.", response:"What is the U.S. Green Building Council?" },
      { value:200, clue:"Innovation summits, AI pilots, and Turner Ventures all help Turner drive this.", response:"What is industry transformation (or innovation)?" },
      { value:300, clue:"Transparency, ethics, and ISO certifications demonstrate Turner’s commitment to this.", response:"What is good governance?" },
      { value:400, clue:"Collaborating with clients, partners, and global affiliates helps Turner do this across the construction industry.", response:"What is lead change (or set industry standards)?" },
    ]}
  ];

  const FINAL = {
    clue: "This is Turner’s guiding vision that connects caring for people, communities, and the planet with building a better future.",
    response: "What is Building Today to Transform Tomorrow™?",
  };

  const ALLOWED_STATES = new Set(["hidden","clue","response","done"]);
  const nextState = (s)=> s==="hidden"?"clue":(s==="clue"?"response":(s==="response"?"done":"done"));
  const pickRandomTile = ()=>({ col: Math.floor(Math.random()*BOARD.length), row: Math.floor(Math.random()*BOARD[0].clues.length) });

  const CONTESTANTS = [
    { id: 'contestant-1', name: 'Contestant 1', key: '1', score: 0 },
    { id: 'contestant-2', name: 'Contestant 2', key: '2', score: 0 },
    { id: 'contestant-3', name: 'Contestant 3', key: '3', score: 0 },
  ];

  // State
  let states = BOARD.map(col=>col.clues.map(()=>"hidden"));
  let doublePos = pickRandomTile();
  let flashingPos = null; // {col,row}
  let gameEnded = false;
  let showFinal = false;
  let finalRevealed = false;
  let activeTile = null; // {col,row}
  let buzzersEnabled = false;
  let currentResponder = null;
  let hostPreviewTile = null;

  // DOM refs
  const boardEl = document.getElementById('board');
  const remainingText = document.getElementById('remainingText');
  const resetBtn = document.getElementById('resetBtn');
  const finalBtn = document.getElementById('finalBtn');
  const audio = document.getElementById('final-audio');

  const modal = document.getElementById('modal');
  const finalToggle = document.getElementById('finalToggle');
  const finalContent = document.getElementById('finalContent');
  const revealBtn = document.getElementById('revealBtn');
  const closeBtn = document.getElementById('closeBtn');
  const scoreboardList = document.getElementById('scoreboardList');
  const buzzerControls = document.getElementById('buzzerControls');
  const buzzerStatus = document.getElementById('buzzerStatus');
  const buzzerIndicator = document.getElementById('buzzerIndicator');
  const hostControls = document.getElementById('hostControls');
  const markCorrectBtn = document.getElementById('markCorrect');
  const markIncorrectBtn = document.getElementById('markIncorrect');
  const clearBuzzBtn = document.getElementById('clearBuzz');
  const revealTileBtn = document.getElementById('revealTile');
  const hostAnswerPanel = document.getElementById('hostAnswerPanel');
  const hostAnswerMeta = document.getElementById('hostAnswerMeta');
  const hostAnswerText = document.getElementById('hostAnswerText');

  const contestantEls = new Map();
  const scoreEls = new Map();
  const buzzerBtnEls = new Map();
  const keyToContestant = new Map();

  const CLIENT_ID = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
  const CHANNEL_NAME = 'esg-jeopardy-sync';
  const STORAGE_KEY = `__${CHANNEL_NAME}`;
  const broadcastChannel = typeof BroadcastChannel === 'function' ? new BroadcastChannel(CHANNEL_NAME) : null;

  if(broadcastChannel){
    broadcastChannel.onmessage = (event)=>{
      const data = event && event.data;
      if(!data || data.senderId === CLIENT_ID) return;
      handleSyncMessage(data);
    };
  } else {
    window.addEventListener('storage', (event)=>{
      if(event.key !== STORAGE_KEY || !event.newValue) return;
      try{
        const data = JSON.parse(event.newValue);
        if(!data || data.senderId === CLIENT_ID) return;
        handleSyncMessage(data);
      }catch(e){
        console.warn('Failed to parse sync message', e);
      }
    });
  }

  function broadcast(type,payload){
    if(!IS_HOST) return;
    const message = { senderId: CLIENT_ID, type, payload, ts: Date.now() };
    if(broadcastChannel){
      try{ broadcastChannel.postMessage(message); }catch(e){ console.warn('Broadcast channel failed', e); }
    } else {
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(message));
        localStorage.removeItem(STORAGE_KEY);
      }catch(e){
        console.warn('LocalStorage broadcast failed', e);
      }
    }
  }

  function broadcastScores(){
    broadcast('scores',{contestants: CONTESTANTS.map(({id,score})=>({id,score}))});
  }

  function formatScore(value){
    try{
      return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(value);
    }catch(_){
      return `$${value}`;
    }
  }

  function setIndicator(message,tone='info'){
    if(!message){
      buzzerIndicator.textContent = '';
      buzzerIndicator.removeAttribute('data-tone');
      buzzerIndicator.style.display = 'none';
      return;
    }
    buzzerIndicator.textContent = message;
    buzzerIndicator.dataset.tone = tone;
    buzzerIndicator.style.display = 'block';
  }

  function setHostPreview(colIdx,rowIdx,item){
    if(!hostAnswerPanel || !hostAnswerMeta || !hostAnswerText) return;
    hostPreviewTile = {col:colIdx,row:rowIdx};
    hostAnswerPanel.dataset.state = 'active';
    const valueLabel = item && typeof item.value === 'number' ? formatScore(item.value) : '';
    hostAnswerMeta.textContent = `${BOARD[colIdx].category}${valueLabel ? ` — ${valueLabel}` : ''}`;
    hostAnswerText.textContent = item ? item.response : '';
  }

  function clearHostPreview(){
    if(!hostAnswerPanel || !hostAnswerMeta || !hostAnswerText) return;
    hostPreviewTile = null;
    hostAnswerPanel.removeAttribute('data-state');
    hostAnswerMeta.textContent = 'Select a clue to preview the correct response.';
    hostAnswerText.textContent = '';
  }

  function updateHostControls(){
    const hasResponder = !!currentResponder;
    [markCorrectBtn,markIncorrectBtn,clearBuzzBtn].forEach(btn=>{ if(btn) btn.disabled = !hasResponder; });
    if(hostControls) hostControls.classList.toggle('active', hasResponder);
    if(revealTileBtn){
      const canReveal = !!activeTile && states[activeTile.col][activeTile.row]==='clue';
      revealTileBtn.disabled = !canReveal;
    }
  }

  function updateContestantDisplay(){
    CONTESTANTS.forEach(contestant=>{
      const row = contestantEls.get(contestant.id);
      const scoreEl = scoreEls.get(contestant.id);
      if(scoreEl) scoreEl.textContent = formatScore(contestant.score);
      if(row) row.classList.toggle('active', !!currentResponder && currentResponder.id===contestant.id);
    });
  }

  function applyScores(data){
    if(!Array.isArray(data)) return;
    data.forEach(item=>{
      if(!item) return;
      const contestant = CONTESTANTS.find(c=>c.id===item.id);
      if(contestant && typeof item.score === 'number'){
        contestant.score = item.score;
      }
    });
    updateContestantDisplay();
  }

  function disableBuzzers(message='Buzzers locked'){
    buzzersEnabled = false;
    buzzerBtnEls.forEach(btn=>{ btn.disabled = true; });
    buzzerStatus.textContent = message;
  }

  function enableBuzzers(message='Buzzers ready (keys 1-3)'){
    if(gameEnded || !activeTile) return;
    buzzersEnabled = true;
    buzzerBtnEls.forEach(btn=>{ btn.disabled = false; });
    buzzerStatus.textContent = message;
  }

  function resetBuzzerSystem(){
    activeTile = null;
    currentResponder = null;
    disableBuzzers('Buzzers locked');
    setIndicator('');
    updateContestantDisplay();
    updateHostControls();
  }

  function prepareBuzzersForClue(){
    if(!activeTile || gameEnded) return;
    currentResponder = null;
    updateContestantDisplay();
    updateHostControls();
    enableBuzzers();
    setIndicator('Buzzers open. Awaiting a contestant.', 'ready');
  }

  function handleBuzzerStateForTile(colIdx,rowIdx,state){
    if(state==='clue'){
      activeTile = {col:colIdx,row:rowIdx};
      prepareBuzzersForClue();
      return;
    }

    if(!activeTile || activeTile.col!==colIdx || activeTile.row!==rowIdx) return;

    if(state==='hidden'){
      resetBuzzerSystem();
    } else if(state==='response'){
      disableBuzzers('Buzzers locked');
      if(!currentResponder) setIndicator('Clue resolved.', 'info');
      currentResponder = null;
      updateContestantDisplay();
      updateHostControls();
    } else if(state==='done'){
      activeTile = null;
    }
  }

  function buildContestantUI(){
    contestantEls.clear();
    scoreEls.clear();
    buzzerBtnEls.clear();
    keyToContestant.clear();
    scoreboardList.innerHTML = '';
    buzzerControls.innerHTML = '';

    CONTESTANTS.forEach(contestant=>{
      const row = document.createElement('div');
      row.className = 'contestant';
      row.dataset.contestantId = contestant.id;
      const nameEl = document.createElement('span');
      nameEl.className = 'contestant-name';
      nameEl.textContent = contestant.name;
      const scoreEl = document.createElement('span');
      scoreEl.className = 'contestant-score';
      scoreEl.textContent = formatScore(contestant.score);
      row.appendChild(nameEl);
      row.appendChild(scoreEl);
      scoreboardList.appendChild(row);
      contestantEls.set(contestant.id,row);
      scoreEls.set(contestant.id,scoreEl);

      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'btn buzzer-btn';
      button.textContent = `${contestant.name} (${contestant.key})`;
      button.setAttribute('aria-label', `Buzz for ${contestant.name} (key ${contestant.key})`);
      button.addEventListener('click', ()=>handleBuzz(contestant));
      buzzerControls.appendChild(button);
      buzzerBtnEls.set(contestant.id,button);

      keyToContestant.set(contestant.key,contestant);
      keyToContestant.set(String(contestant.key).toLowerCase(),contestant);
      keyToContestant.set(String(contestant.key).toUpperCase(),contestant);
    });

    disableBuzzers('Buzzers locked');
    setIndicator('');
    updateHostControls();
  }

  function handleBuzz(contestant){
    if(gameEnded || !buzzersEnabled || currentResponder || !activeTile) return;
    currentResponder = contestant;
    disableBuzzers('Buzzers locked');
    updateContestantDisplay();
    updateHostControls();
    setIndicator(`${contestant.name} buzzed in!`, 'active');
  }

  function handleCorrect(){
    if(!currentResponder || !activeTile) return;
    const contestant = currentResponder;
    const value = BOARD[activeTile.col].clues[activeTile.row].value || 0;
    contestant.score += value;
    currentResponder = null;
    updateContestantDisplay();
    updateHostControls();
    disableBuzzers('Buzzers locked');
    setIndicator(`${contestant.name} is correct! Reveal when ready.`, 'success');
    broadcastScores();
  }

  function handleIncorrect(){
    if(!currentResponder || !activeTile) return;
    const contestant = currentResponder;
    const value = BOARD[activeTile.col].clues[activeTile.row].value || 0;
    contestant.score -= value;
    currentResponder = null;
    updateContestantDisplay();
    updateHostControls();
    enableBuzzers('Buzzers reopened');
    setIndicator(`${contestant.name} is incorrect. Buzzers reopened.`, 'warn');
    broadcastScores();
  }

  function handleClear(){
    if(!currentResponder || !activeTile) return;
    const name = currentResponder.name;
    currentResponder = null;
    updateContestantDisplay();
    updateHostControls();
    enableBuzzers('Buzzers reopened');
    setIndicator(`Buzz cleared for ${name}. Awaiting buzz.`, 'info');
  }

  function revealActiveTile(options={}){
    const fromSync = !!options.fromSync;
    const colIdx = options.colIdx ?? (activeTile && activeTile.col);
    const rowIdx = options.rowIdx ?? (activeTile && activeTile.row);
    if(colIdx===undefined || rowIdx===undefined) return;
    if(IS_HOST && !fromSync) broadcast('revealTile',{colIdx,rowIdx});
    setTileState(colIdx,rowIdx,'response',options);
    setTileState(colIdx,rowIdx,'done',options);
    updateRemaining();
  }

  function handleSyncMessage(message){
    if(!message || typeof message !== 'object') return;
    const { type, payload } = message;
    switch(type){
      case 'advanceTile':
        if(payload) advanceTile(payload.colIdx,payload.rowIdx,{fromSync:true});
        break;
      case 'setTileState':
        if(payload) setTileState(payload.colIdx,payload.rowIdx,payload.state,{fromSync:true,broadcast:false});
        updateRemaining();
        break;
      case 'scores':
        if(payload) applyScores(payload.contestants);
        break;
      case 'resetBoard':
        resetBoard({fromSync:true});
        break;
      case 'openFinal':
        openFinal({fromSync:true});
        break;
      case 'closeFinal':
        closeFinal({fromSync:true});
        break;
      case 'toggleFinal':
        if(payload && Object.prototype.hasOwnProperty.call(payload,'force')){
          toggleFinal({fromSync:true, force: payload.force});
        } else {
          toggleFinal({fromSync:true});
        }
        break;
      case 'revealTile':
        if(payload) revealActiveTile({fromSync:true,colIdx:payload.colIdx,rowIdx:payload.rowIdx});
        break;
      default:
        break;
    }
  }

  // Build Board DOM once
  const colEls = [];
  const tileBtn = (colIdx,rowIdx)=>document.getElementById(`tile-${colIdx}-${rowIdx}`);

  function buildBoard(){
    boardEl.innerHTML = '';
    BOARD.forEach((column, colIdx)=>{
      const col = document.createElement('div');
      col.className = 'col';
      const cat = document.createElement('div');
      cat.className = 'cat';
      cat.textContent = column.category;
      col.appendChild(cat);

      column.clues.forEach((item,rowIdx)=>{
        const btn = document.createElement('button');
        btn.id = `tile-${colIdx}-${rowIdx}`;
        btn.className = 'tile hidden';
        btn.setAttribute('aria-label', `Reveal ${item.value} clue`);
        btn.addEventListener('click', ()=>advanceTile(colIdx,rowIdx));
        const content = document.createElement('span');
        content.className = 'content';
        content.style.display = 'block';
        content.style.fontWeight = '600';
        content.style.fontSize = '1.125rem';
        content.style.lineHeight = '1.25';
        content.textContent = item.value;
        btn.appendChild(content);
        const tag = document.createElement('span');
        tag.className = 'value-tag';
        tag.textContent = item.value;
        btn.appendChild(tag);
        col.appendChild(btn);
      });

      colEls.push(col);
      boardEl.appendChild(col);
    });
    updateRemaining();
  }

  function updateRemaining(){
    const remaining = states.flat().filter(s=>s!=="done").length;
    remainingText.textContent = `Remaining tiles: ${remaining}`;
  }

  function setTileState(colIdx,rowIdx,state,options){
    options = options || {};
    states[colIdx][rowIdx] = state;
    const btn = tileBtn(colIdx,rowIdx);
    const item = BOARD[colIdx].clues[rowIdx];
    const content = btn.querySelector('.content');
    btn.classList.remove('hidden','clue','response','done');
    btn.classList.add(state);

    if(state==='hidden'){
      content.textContent = item.value;
      btn.querySelector('.value-tag').style.display = '';
      btn.disabled = false;
      btn.setAttribute('aria-label',`Reveal ${item.value} clue`);
    } else if(state==='clue'){
      content.textContent = item.clue;
      btn.querySelector('.value-tag').style.display = 'none';
      btn.disabled = false;
      btn.setAttribute('aria-label','Reveal correct response');
    } else if(state==='response'){
      content.textContent = item.response;
      btn.querySelector('.value-tag').style.display = 'none';
      btn.disabled = false;
      btn.setAttribute('aria-label','Played');
    } else { // done
      content.innerHTML = '<span class="played">Played</span>';
      btn.querySelector('.value-tag').style.display = 'none';
      btn.disabled = true;
      btn.setAttribute('aria-label','Played');
    }

    handleBuzzerStateForTile(colIdx,rowIdx,state);
    if(state==='clue'){
      setHostPreview(colIdx,rowIdx,item);
    } else if(hostPreviewTile && hostPreviewTile.col===colIdx && hostPreviewTile.row===rowIdx){
      clearHostPreview();
    }
    if(IS_HOST) updateHostControls();
    if(IS_HOST && options.broadcast !== false && !options.fromSync){
      broadcast('setTileState',{colIdx,rowIdx,state});
    }
  }

  function isFlashingAt(colIdx,rowIdx){
    return !!flashingPos && flashingPos.col===colIdx && flashingPos.row===rowIdx;
  }

  function setFlashing(colIdx,rowIdx,enable){
    const btn = tileBtn(colIdx,rowIdx);
    if(enable){
      const overlay = document.createElement('div');
      overlay.className = 'flash';
      overlay.innerHTML = '<div><div style="font-size:.75rem;letter-spacing:.25em">DOUBLE</div><div style="font-weight:800;font-size:1.5rem;line-height:1">JEOPARDY!</div></div>';
      overlay.dataset.flash = '1';
      btn.appendChild(overlay);
      btn.disabled = true;
    } else {
      const overlay = btn.querySelector('.flash');
      if(overlay) overlay.remove();
      btn.disabled = false;
    }
  }

  function isDoubleAt(colIdx,rowIdx){
    return doublePos && doublePos.col===colIdx && doublePos.row===rowIdx;
  }

  function advanceTile(colIdx,rowIdx,options={}){
    const fromSync = !!options.fromSync;
    if(!fromSync && !IS_HOST) return;
    if(gameEnded && !fromSync) return;
    const currentState = states[colIdx][rowIdx];
    if(!fromSync && currentState==='clue') return; // wait for explicit reveal control
    if(IS_HOST && !fromSync) broadcast('advanceTile',{colIdx,rowIdx});

    // Double Jeopardy behaviour
    if(isDoubleAt(colIdx,rowIdx)){
      if(currentState==='hidden'){
        flashingPos = {col:colIdx,row:rowIdx};
        setFlashing(colIdx,rowIdx,true);
        setTimeout(()=>{
          setFlashing(colIdx,rowIdx,false);
          flashingPos = null;
          setTileState(colIdx,rowIdx,'clue',options);
          updateRemaining();
        },2000);
        return;
      }
    }

    // Regular flow
    const next = nextState(currentState);
    setTileState(colIdx,rowIdx,next,options);
    updateRemaining();
  }

  function resetBoard(options={}){
    const fromSync = !!options.fromSync;
    states = BOARD.map(col=>col.clues.map(()=>"hidden"));
    flashingPos = null;
    doublePos = pickRandomTile();
    gameEnded = false;
    showFinal = false;
    finalRevealed = false;
    CONTESTANTS.forEach(contestant=>{ contestant.score = 0; });
    resetBuzzerSystem();
    try{ audio.pause(); audio.currentTime = 0; }catch(e){}
    // Re-render tiles
    BOARD.forEach((col,ci)=>col.clues.forEach((_,ri)=>setTileState(ci,ri,'hidden',{broadcast:false})));
    updateContestantDisplay();
    clearHostPreview();
    updateHostControls();
    updateRemaining();
    if(IS_HOST && !fromSync){
      broadcast('resetBoard',{});
      broadcastScores();
    }
  }

  const DEFAULT_FINAL_SRC = 'JeopardyMusic.mp3';

  async function openFinal(options={}){
    const fromSync = !!options.fromSync;
    gameEnded = true; // disables board via disabled attr set when reaching 'done' only; we prevent clicks by short-circuit
    showFinal = true;
    finalRevealed = false;
    resetBuzzerSystem();
    clearHostPreview();
    setIndicator('Final Jeopardy in progress. Buzzers disabled.', 'info');
    finalContent.textContent = FINAL.clue;
    finalToggle.setAttribute('aria-pressed','false');
    revealBtn.style.display = '';
    modal.style.display = 'flex';
    if(IS_HOST && !fromSync){
      broadcast('openFinal',{});
    }
    try{
      audio.src = DEFAULT_FINAL_SRC;
      audio.currentTime = 0;
      audio.loop = true;
      await audio.play();
    }catch(e){
      console.warn('Final Jeopardy audio playback failed:', e);
    }
  }
  function closeFinal(options={}){
    const fromSync = !!options.fromSync;
    modal.style.display = 'none';
    showFinal = false;
    if(IS_HOST && !fromSync){
      broadcast('closeFinal',{});
    }
    try{ audio.pause(); audio.currentTime = 0; }catch(e){}
  }
  function toggleFinal(options={}){
    const fromSync = !!options.fromSync;
    if(Object.prototype.hasOwnProperty.call(options,'force')){
      finalRevealed = !!options.force;
    } else {
      finalRevealed = !finalRevealed;
    }
    finalContent.textContent = finalRevealed ? FINAL.response : FINAL.clue;
    finalToggle.setAttribute('aria-pressed', String(finalRevealed));
    revealBtn.style.display = finalRevealed ? 'none' : '';
    if(IS_HOST && !fromSync){
      broadcast('toggleFinal',{force: finalRevealed});
    }
  }

  // Wire up controls
  resetBtn.addEventListener('click', ()=>{ if(!IS_HOST) return; resetBoard(); });
  finalBtn.addEventListener('click', ()=>{ if(!IS_HOST) return; openFinal(); });
  closeBtn.addEventListener('click', ()=>{ if(!IS_HOST) return; closeFinal(); });
  revealBtn.addEventListener('click', ()=>{ if(!IS_HOST || finalRevealed) return; toggleFinal(); });
  finalToggle.addEventListener('click', ()=>{ if(!IS_HOST) return; toggleFinal(); });
  finalToggle.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); if(!IS_HOST) return; toggleFinal(); }});
  if(revealTileBtn) revealTileBtn.addEventListener('click', ()=>{ if(!IS_HOST) return; revealActiveTile(); });
  markCorrectBtn.addEventListener('click', ()=>{ if(!IS_HOST) return; handleCorrect(); });
  markIncorrectBtn.addEventListener('click', ()=>{ if(!IS_HOST) return; handleIncorrect(); });
  clearBuzzBtn.addEventListener('click', ()=>{ if(!IS_HOST) return; handleClear(); });

  document.addEventListener('keydown',(event)=>{
    if(event.repeat) return;
    const activeTag = (document.activeElement && document.activeElement.tagName) ? document.activeElement.tagName.toUpperCase() : '';
    if(activeTag==='INPUT' || activeTag==='TEXTAREA') return;
    const contestant = keyToContestant.get(event.key);
    if(!contestant) return;
    event.preventDefault();
    handleBuzz(contestant);
  });

  // Build once and init states
  buildContestantUI();
  buildBoard();
  // Initialize each tile explicitly so content matches state
  BOARD.forEach((col,ci)=>col.clues.forEach((_,ri)=>setTileState(ci,ri,'hidden',{broadcast:false})));

  // Minimal runtime assertions in console (dev aid)
  try{
    console.assert(Array.isArray(BOARD)&&BOARD.length===4,'[TEST] Expected 4 categories');
    BOARD.forEach((c,i)=>{ console.assert(Array.isArray(c.clues)&&c.clues.length===4,`[TEST] Expected 4 clues in column ${i}`); });
    console.assert(ALLOWED_STATES.has(states[0][0]), '[TEST] Valid state');
  }catch(e){ console.warn('[TEST] Runtime assertions raised:',e); }
  </script>
</body>
</html>
